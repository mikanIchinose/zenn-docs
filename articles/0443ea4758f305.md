---
title: "ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã—ã‹ãŠç›®ã«ã‹ã‹ã‚Œãªã„çã—ã„å®Ÿè£…"
emoji: "ğŸ“š"
type: "tech"
topics: ["kotlin", "android"]
published: true
---

11/11ã«[GMOãƒ¡ã‚¤ã‚¯ã‚¢ãƒ—ãƒªãƒ»Sansan ãƒ¢ãƒã‚¤ãƒ«å‹‰å¼·ä¼š in ç¦å²¡](https://sansan.connpass.com/event/335012/)ã¨ã„ã†ã‚¤ãƒ™ãƒ³ãƒˆã§LTã‚’ã•ã›ã¦ã‚‚ã‚‰ã£ãŸãƒã‚¿ãªã‚“ã§ã™ãŒã€Xã§æ€ã„ã®ã»ã‹åéŸ¿ãŒã‚ã£ãŸã®ã§è¨˜äº‹ã¨ã—ã¦æ›¸ãèµ·ã“ãã†ã¨ãŠã‚‚ã„ã¾ã—ãŸã€‚

https://speakerdeck.com/mikanichinose/raiburaridesikaomu-nikakarenaizhen-siishi-zhuang

ãŸã¾ã«[Compose](https://cs.android.com/androidx/platform/frameworks/support/+/androidx-main:compose/)ã‚„[coroutine](https://github.com/Kotlin/kotlinx.coroutines)ã®å®Ÿè£…ã‚’è¦‹ã«ã„ãã“ã¨ãŒã‚ã‚‹ã®ã§ã™ãŒã€æ™®æ®µã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã§ã¯ã‚ã¾ã‚Šã¿ãªã„ä¸æ€è­°ãªå®Ÿè£…ãŒã‚ã£ãŸã®ã§ã€ä»Šå›ã¯3ã¤ç´¹ä»‹ã—ãŸã„ã¨ãŠã‚‚ã„ã¾ã™

## Avoid using data class

1ã¤ç›®ã¯data classã‚’é¿ã‘ã‚‹ã¨ã„ã†ã“ã¨ã§ã™

### What

ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå…¬é–‹ã—ã¦ã„ã‚‹APIã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ä¸€è¦‹`data class`ã§å®Ÿè£…ã—ã¦ã‚‚ã‚ˆã•ãã†ãªã®ã«ã€æ™®é€šã«classã§å®Ÿè£…ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™

```kotlin
// ä¾‹: composeã®ãƒœã‚¿ãƒ³ã®è‰²ã‚’å®šç¾©ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…ã®ä¸€éƒ¨
// https://cs.android.com/androidx/platform/frameworks/support/+/androidx-main:compose/material3/material3/src/commonMain/kotlin/androidx/compose/material3/Button.kt;l=1217-1279
@Immutable
class ButtonColors
constructor(
    val containerColor: Color,
    val contentColor: Color,
    val disabledContainerColor: Color,
    val disabledContentColor: Color,
) {
    // data classã ã¨è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹copyã‚’ã‚ã–ã‚ã–è‡ªå‰å®Ÿè£…ã—ã¦ã„ã‚‹ï¼
    fun copy(
        containerColor: Color = this.containerColor,
        contentColor: Color = this.contentColor,
        disabledContainerColor: Color = this.disabledContainerColor,
        disabledContentColor: Color = this.disabledContentColor
    ) =
        ButtonColors(
            containerColor.takeOrElse { this.containerColor },
            contentColor.takeOrElse { this.contentColor },
            disabledContainerColor.takeOrElse { this.disabledContainerColor },
            disabledContentColor.takeOrElse { this.disabledContentColor },
        )

    // ...

    // hashCodeã‚‚ä¸Šæ›¸ãã—ã¦ã„ã‚‹ï¼
    override fun hashCode(): Int {
        var result = containerColor.hashCode()
        result = 31 * result + contentColor.hashCode()
        result = 31 * result + disabledContainerColor.hashCode()
        result = 31 * result + disabledContentColor.hashCode()
        return result
    }
}
```

### Why

ãªãœã“ã®ã‚ˆã†ãªã“ã¨ã‚’ã—ã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨ã€ä¸€è¨€ã§ã„ãˆã°ã€ãƒã‚¤ãƒŠãƒªäº’æ›æ€§ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã§ã™ã€‚
`data class`ã‚’ã¤ã‹ã†ã¨ã€`copy`ãƒ¡ã‚½ãƒƒãƒ‰ã‚„ã€destructuringã®ãŸã‚ã®`componentN`ãƒ¡ã‚½ãƒƒãƒ‰ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ä¾¿åˆ©ã§ã™ãŒã€ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¯ãƒã‚¤ãƒŠãƒªäº’æ›æ€§ãŒè€ƒæ…®ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
ãŸã¨ãˆã°ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’1ä»¶è¿½åŠ ã—ãŸã‚‰ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¨`copy`ãƒ¡ã‚½ãƒƒãƒ‰ã®äº’æ›æ€§ãŒå£Šã‚Œã¾ã™ã—ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®é †ç•ªã‚’å¤‰ãˆã‚‹ã ã‘ã§ã‚‚ã€`conponentN`ãƒ¡ã‚½ãƒƒãƒ‰ã®äº’æ›æ€§ãŒå£Šã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚
ã“ã®ã‚ˆã†ãªä¸å®‰å®šãªå®Ÿè£…ã¯å…¬é–‹APIã«ã¯ä½¿ã‚ãšã€æ™®é€šã«`class`ã§å®Ÿè£…ã—ã¦ã€å¿…è¦ãŒã‚ã‚Œã°`hashCode`ã‚„`copy`ã‚’è‡ªå‰å®Ÿè£…ã—ã¾ã™ã€‚

- `data class`ãŒç”Ÿæˆã™ã‚‹`copy`ã‚„`componentN`ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¯ABIäº’æ›æ€§ãŒè€ƒæ…®ã•ã‚Œã¦ã„ãªã„
  - ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ãŸã‚‰ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚„`copy`ãƒ¡ã‚½ãƒƒãƒ‰ã®äº’æ›æ€§ãŒå£Šã‚Œã‚‹
  - ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®é †ç•ªã‚’å…¥ã‚Œæ›¿ãˆãŸã‚‰ã€`componentN`ãƒ¡ã‚½ãƒƒãƒ‰ã®äº’æ›æ€§ãŒå£Šã‚Œã‚‹


Kotlinã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªè£½ä½œè€…å‘ã‘ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚‚è¨˜è¼‰ãŒã‚ã‚Šã¾ã™
https://kotlinlang.org/docs/api-guidelines-backward-compatibility.html#avoid-using-data-classes-in-your-api

## Fake constructor

2ã¤ç›®ã¯Fake constructorã¨ã„ã†å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™


ViewModelã®ä¸­ã§çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«ã€StateFlowã‚’ã¤ã‹ã†ã“ã¨ãŒã‚ã‚‹ã¨ãŠã‚‚ã„ã¾ã™ã€‚`MutableStateFlow()`ã¨ã‚ˆã³ã ã—ã¦ã€å†…éƒ¨ã§å¯å¤‰ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç”¨æ„ã—ã¾ã™ãŒã€ã“ã®ã¨ãã«ä½¿ç”¨ã—ãŸ`MutableStateFlow`ã¯å®Ÿã¯ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```kotlin
private val _counter = MutableStateFlow(0)
```

`MutableStateFlow`ã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ã“ã‚Œã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ã„ã†ã“ã¨ã¯ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’ã‚‚ã¤ã“ã¨ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚

```kotlin
public interface MutableStateFlow<T> : StateFlow<T>, MutableSharedFlow<T> {
    // ...
}
```

ã©ã†ãªã£ã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨ã€**`MutableStateFlow`ã¨ã„ã†åå‰ã®é–¢æ•°**ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã®é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`MutableStateFlow`ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹`StateFlowImpl`ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å‘¼ã³å‡ºã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚Šã¾ã™ã€‚

```kotlin
public fun <T> MutableStateFlow(value: T): MutableStateFlow<T> = 
    StateFlowImpl(value ?: NULL)
```

ã“ã®ã‚ˆã†ã«é–¢æ•°åã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨åŒã˜ã«ã—ã¦ã€ã‚ãŸã‹ã‚‚ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‹ã®ã‚ˆã†ã«è¦‹ã›ã‹ã‘ã‚‹ã®ãŒFake Constructorã¨ã„ã†å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™

### Why

ãªãœã“ã®ã‚ˆã†ãªå®Ÿè£…ãŒå¿…è¦ãªã®ã‹ã¨è¨€ãˆã°ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ç’°å¢ƒã¨ã®é•ã„ã‚’è€ƒãˆã‚Œã°ã‚ˆãã€é€šå¸¸ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ã£ãŸå®Ÿè£…ã¯`hilt`ãªã©ã®DIã‚³ãƒ³ãƒ†ãƒŠãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã„ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿä½“ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦æ³¨å…¥ã™ã‚‹ã“ã¨ãŒå¤šã„ã¨æ€ã„ã¾ã™ãŒã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¯ãã®ã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã¯ä½¿ãˆã¾ã›ã‚“ã€‚
ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®åˆ©ç”¨è€…ã¯hiltã‚’ä½¿ã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã—ã€koinã‚’ä½¿ã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã—ã€ãªã«ã‚‚ä½¿ã‚ãšã«Pure DIã‚’ã—ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã‹ã‚‰ã§ã™ã€‚
ãã®ã‚ˆã†ãªåˆ¶ç´„ã®ãªã‹ã§ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã ã‘å…¬é–‹ã—ã¦ã€å®Ÿè£…ã‚¯ãƒ©ã‚¹ã‚’éš ã™ãŸã‚ã®å·¥å¤«ã¨ã—ã¦Fake ConstructorãŒåˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚“ã ã¨ãŠã‚‚ã„ã¾ã™ã€‚

## Readonly implementation

3ã¤ç›®ã¯Readonlyãªå®Ÿè£…ã§ã™

ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯`MutableStateFlow`ã‚’`StateFlow`ã«ã‚¢ãƒƒãƒ—ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹ã¨ãã«ä½¿ã†`asStateFlow`ãƒ¡ã‚½ãƒƒãƒ‰ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
`asStateFlow`ã‚’å®Ÿè¡Œã™ã‚‹ã¨`ReadonlyStateFlow`ã¨ã„ã†èãé¦´æŸ“ã¿ã®ãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œã‚‰ã‚Œã¾ã™ã€‚

```kotlin
public fun <T> MutableStateFlow<T>.asStateFlow(): StateFlow<T> =
    ReadonlyStateFlow(this, null)
```

`ReadonlyStateFlow`ã®å®Ÿè£…ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¦ã€`StateFlow`ã®å®Ÿè£…ã®1ã¤ã§ã™ã€‚

```kotlin
@OptIn(ExperimentalForInheritanceCoroutinesApi::class)
private class ReadonlyStateFlow<T>(
    flow: StateFlow<T>,
    @Suppress("unused")
    private val job: Job? // keeps a strong reference to the job (if present)
) : StateFlow<T> by flow, CancellableFlow<T>, FusibleFlow<T> {
    override fun fuse(context: CoroutineContext, capacity: Int, onBufferOverflow: BufferOverflow) =
        fuseStateFlow(context, capacity, onBufferOverflow)
}
```

### Why

`ReadonlyStateFlow`ãŒã‚ã‚‹ã¨ãªã«ãŒå¬‰ã—ã„ã‹ã¨ã„ã†ã¨ã€ãŸã¨ãˆã°ã€`LiveData`ã®é ƒã®ã‚ˆã†ã«ã€å…¬é–‹ã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å‹ã‚’`StateFlow`ã¨æ˜ç¤ºã—ã¦ã€ã‚¢ãƒƒãƒ—ã‚­ãƒ£ã‚¹ãƒˆã—ã¦ã—ã¾ã†ã¨ã€ãã‚Œã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã§`MutableStateFlow`ã«ãƒ€ã‚¦ãƒ³ã‚­ãƒ£ã‚¹ãƒˆã§ãã¦ã—ã¾ã„ã¾ã™ã€‚
ã“ã‚Œã ã¨ã€çŠ¶æ…‹ã®æ›´æ–°ãŒViewModelã«é–‰ã˜ãªããªã£ã¦ã—ã¾ã†ã®ã§ç®¡ç†ãŒã—ã¥ã‚‰ããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

```kotlin
class MainViewModel: ViewModel() {
    private val _uiState = MutableStateFlow(MainUiState())
    val uiState: StateFlow<MainUiState> = _uiState
}

    (viewModel.uiState as MutableStateFlow<MainUiModel>).update {
//  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
//     down cast to MutableStateFlow
    }
```

`asStateFlow`ã‚’ä½¿ã£ã¦å…¬é–‹ã™ã‚‹ã¨ã€`MutableStateFlow`ã«ãƒ€ã‚¦ãƒ³ã‚­ãƒ£ã‚¹ãƒˆã—ã‚ˆã†ã¨ã—ã¦ã‚‚ã€`ReadonlyStateFlow`ã¨`MutableStateFlow`ã¯èµ¤ã®ä»–äººãªã®ã§ãƒ€ã‚¦ãƒ³ã—ã‚ˆã†ãŒãªãã€`ClassCastException`ãŒåã‹ã‚Œã¦ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹ã®ã§ã€æ„å›³ã—ãªã„çŠ¶æ…‹æ›´æ–°ã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™

```kotlin
class MainViewModel: ViewModel() {
    private val _uiState = MutableStateFlow(MainUiState())
    val uiState = _uiState.asStateFlow()
}

    (viewModel.uiState as MutableStateFlow<MainUiModel>).update {
//  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
//              throw ClassCastException
    }
```

ä»¥ä¸Šã®3ã¤ãŒãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã—ã‹ã¿ã‚‰ã‚Œãªã„çã—ã„å®Ÿè£…ã§ã—ãŸ
ã¿ãªã•ã‚“ã‚‚æ™®æ®µåˆ©ç”¨ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã‚‹ã¨æ–°ãŸãªç™ºè¦‹ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã®ã§æ˜¯éã‚„ã£ã¦ã¿ã¦ãã ã•ã„ï¼

