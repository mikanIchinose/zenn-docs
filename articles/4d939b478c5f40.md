---
title: "[å‚™å¿˜éŒ²] roborazziå°å…¥ã—ã¦ã¿ãŸ"
emoji: "ğŸ¤–"
type: "tech"
topics: ["android"]
published: true
publication_name: "karabiner_inc"
---

æ¡ˆä»¶ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«roborazziã‚’å°å…¥ã—ã‚ˆã†ã¨ã—ã¦ã€ã„ã‚ã„ã‚ã¯ã¾ã£ãŸã¨ã“ã‚ãŒã‚ã£ãŸã®ã§å‚™å¿˜éŒ²çš„ãªè¨˜éŒ²ã‚’ã—ã¾ã™

## ã‚´ãƒ¼ãƒ«
- junit5ã‚’ä½¿ã£ã¦å˜ä½“ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«roborazziã‚’å°å…¥ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹
- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚¹ãƒˆã®å¦¨ã’ã«ãªã‚‹Composableé–¢æ•°ãŒåˆ†ã‹ã‚‹ã‚ˆã†ã«ãªã‚‹

## ä¾å­˜ã‚’è¿½åŠ 

```diff
  // root-level build.gradle.kts
  plugin {
      // ...
+     id("io.github.takahirom.roborazzi") version "1.29.0" apply false
  }
```

```diff
  // module-level build.gradle.kts
  plugin {
      // ...
+     id("io.github.takahirom.roborazzi")
  }
  android {
      // ...
+     testOptions {
+         unitTests {
+             isIncludeAndroidResources = true
+             all {
+                 it.systemProperties["robolectric.pixelCopyRenderMode"] = "hardware"
+             }
+         }
+     }
  }
```

```diff
  // module-level build.gradle.kts
  dependencies {
    // ...
+   implementation("junit:junit:4.13.2")
+   implementation("org.robolectric:robolectric:4.13")
+   implementation("io.github.takahirom.roborazzi:roborazzi:1.29.0")
+   implementation("io.github.takahirom.roborazzi:roborazzi-junit-rule:1.29.0")
+   implementation("io.github.takahirom.roborazzi:roborazzi-compose:1.29.0")
+   implementation("io.github.takahirom.roborazzi:roborazzi-compose-preview-scanner-support:1.29.0")
+   implementation("o.github.sergio-sastre.ComposablePreviewScanner:android:0.3.2")
  }
```

## ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚¹ãƒˆè‡ªå‹•ç”Ÿæˆã®ãŸã‚ã®è¨˜è¿°ã‚’ã™ã‚‹

```kotlin
// module-level build.gradle.kts
roborazzi {
    generateComposePreviewRobolectricTests {
        enable = true
        packages = listOf("your.package.name")
        // privateãªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å«ã‚ãŸã„ãªã‚‰includePrivatePreviewsã‚’åˆ©ç”¨ã™ã‚‹
        // includePrivatePreviews = true
    }
}
```

## ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®æ’®å½±ãŠã‚ˆã³å·®åˆ†ç”Ÿæˆ

```sh
// æ¯”è¼ƒå…ƒã¨ãªã‚‹ãƒ–ãƒ©ãƒ³ãƒã«ç§»å‹•
git switch develop

// ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±
./gradlew recordRoborazziDemoDebug

// ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã«ç§»å‹•
git switch {branch}

// å·®åˆ†ã‚’ä½œæˆ
./gradlew compareRoborazziDemoDebug

// tips å·®åˆ†ç”»åƒã®ã¿ã‚’æŠ½å‡º
find . -type f -name "_compare" -exec mv {} . \;
```

## ã¯ã¾ã‚Šãƒã‚¤ãƒ³ãƒˆ1: junit5ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€`junit-vintage-engine`ã‚’è¿½åŠ ã™ã‚‹

roborazziã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã‚‹ãƒ†ã‚¹ãƒˆã¯JUnit4ãƒ™ãƒ¼ã‚¹ã ã£ãŸã®ã§ã€JUnit5ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯junit-vintage-engineã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

```diff
  implementation(platform("org.junit:junit-bom:5.11.3"))
  // run junit4-based test (roborazzi)
+ testRuntimeOnly("org.junit.jupiter:junit-vintage-engine")
  testRuntimeOnly("org.junit.jupiter:junit-jupiter-engine")
  testImplementation("org.junit.jupiter:junit-jupiter-api")
  testImplementation("org.junit.jupiter:junit-jupiter-params")
```

## ã¯ã¾ã‚Šãƒã‚¤ãƒ³ãƒˆ2: Previewã«Dialogã‚’å«ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹

Dialogã‚’ä½¿ã£ãŸComposableé–¢æ•°ã«ã¤ã„ã¦è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã—ã¾ã™

```kotlin
@Composable
fun HogeDialog(
    // ...
) {
    Dialog(
        onDismissRequest = onDismiss,
    ) {
        // content
    }
}
```

```
java.lang.IllegalStateException: Unable to find the image of the target root component. Does the rendering element exist?
    at com.github.takahirom.roborazzi.RoborazziKt.capture(Roborazzi.kt:613)
    at com.github.takahirom.roborazzi.ImageCaptureViewAction.perform(Roborazzi.kt:587)
    at androidx.test.espresso.ViewInteraction$SingleExecutionViewAction.perform(ViewInteraction.java:2)
    at androidx.test.espresso.ViewInteraction.doPerform(ViewInteraction.java:25)
    at androidx.test.espresso.ViewInteraction.-$$Nest$mdoPerform(ViewInteraction.java)
    at androidx.test.espresso.ViewInteraction$1.call(ViewInteraction.java:7)
    at androidx.test.espresso.ViewInteraction$1.call(ViewInteraction.java:1)
    at java.base/java.util.concurrent.FutureTask.run(Unknown Source)
    at android.os.Handler.$$robo$$android_os_Handler$handleCallback(Handler.java:942)
    at android.os.Handler.handleCallback(Handler.java)
    at android.os.Handler.$$robo$$android_os_Handler$dispatchMessage(Handler.java:99)
    ...
```

ã€Œãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¯èƒ½ãªè¦ç´ ãŒãªã„ã‚“ã ãŒï¼Ÿã€ã¨æ€’ã‚‰ã‚Œã¦ã¾ã™ã­
ã“ã®ã‚ˆã†ãªå ´åˆã«ã¯Dialogå†…ã‚’åˆ‡ã‚Šå‡ºã—ã¦ã€ãã‚Œã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã¾ã™

## Caution: Previewé–¢æ•°åã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨åŒã˜åå‰ã«ã—ã¦ã¯ã„ã‘ãªã„

Previewé–¢æ•°åãŒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨åŒä¸€ã§ã‚ã‚Œã°ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã™

```kotlin
@Composable
fun HogeScreen(
    // ...
) {
    // ...
}

@Preview
@Composable
fun HogeScreen() {
    MaterialTheme {
        Surface {
            HogeScreen(
                // ...
            )
        }
    }
}
```

```
java.lang.IllegalArgumentException: wrong number of arguments: 2 expected: 5
    at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.checkArgumentCount(Unknown Source)
    at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(Unknown Source)
    at sergio.sastre.composable.preview.scanner.core.preview.ComposablePreviewInvocationHandler.invoke(ComposablePreviewInvocationHandler.kt:30)
    at jdk.proxy4/jdk.proxy4.$Proxy58.invoke(Unknown Source)
    at sergio.sastre.composable.preview.scanner.core.preview.ProvideComposablePreview$invoke$1.invoke(ProvideComposablePreview.kt)
    at com.github.takahirom.roborazzi.RoborazziPreviewScannerSupportKt$captureRoboImage$1.invoke(RoborazziPreviewScannerSupport.kt:18)
    at com.github.takahirom.roborazzi.RoborazziPreviewScannerSupportKt$captureRoboImage$1.invoke(RoborazziPreviewScannerSupport.kt:17)
    at androidx.compose.runtime.internal.ComposableLambdaImpl.invoke(ComposableLambda.jvm.kt:109)
    at androidx.compose.runtime.internal.ComposableLambdaImpl.invoke(ComposableLambda.jvm.kt:35)
    at androidx.compose.ui.platform.ComposeView.Content(ComposeView.android.kt:441)
    ...
```

## Tips: ãƒ¡ãƒ¢ãƒªã¯æ½¤æ²¢ã«ç”¨æ„ã—ãŸã»ã†ãŒã‚ˆã•ãã†

ãƒ¡ãƒ¢ãƒªä¸è¶³ã§ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã‚„ã™ã„ã®ã§ãƒ’ãƒ¼ãƒ—ã‚µã‚¤ã‚ºã‚’åºƒãç¢ºä¿ã—ã¦ãŠãã“ã¨ã‚’ã‚ªã‚¹ã‚¹ãƒ¡ã—ã¾ã™

```kotlin
android {
    // ...
    testOptions {
        unitTests {
            isIncludeAndroidResources = true
            all {
                maxHeapSize = "4096m"
                it.systemProperties["robolectric.pixelCopyRenderMode"] = "hardware"
            }
        }
    }
}
```
