---
title: "[èª¿æŸ»è¨˜éŒ²] roborazziãŒè‡ªå‹•ç”Ÿæˆã—ãŸPreviewãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹"
emoji: "ğŸ”¥"
type: "tech"
topics: ["android"]
published: true
publication_name: "karabiner_inc"
---

# è«¸æ³¨æ„

æ¥­å‹™ã§å¾—ãŸçŸ¥è¦‹ãªã®ã§ã€è¨˜äº‹ã®ãªã‹ã§ç¤ºã™ã‚³ãƒ¼ãƒ‰ã¯æ”¹å¤‰ã—ã¦ã„ã¾ã™

# `./gradlew recordRoborazzi` ãŒæ­£å¸¸çµ‚äº†ã—ãªã„ï¼ï¼

https://zenn.dev/karabiner_inc/articles/4d939b478c5f40

å‰å›ã€roborazziã‚’å°å…¥ã—ã¦ã¯ã¾ã£ãŸç‚¹ã«ã¤ã„ã¦ã®è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã€‚å®Ÿã¯ãã®è£ã§ã‚‚ã£ã¨ã¯ã¾ã£ã¦ã„ãŸã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã€‚
ãã‚Œã¯ã€`./gradlew recordRoborazzi`ã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã‚ã†ã¨ã—ã¦ã‚‚ã‚¿ã‚¹ã‚¯ãŒæ­£å¸¸çµ‚äº†ã›ãšã«ã€ç”»åƒãŒå‡ºåŠ›ã•ã‚Œãªã„ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚

# çµŒç·¯

1. ã¨ã‚Šã‚ãˆãšã€roborazziãŒå°å…¥ã§ãã‚‹ã‹è©¦ã—ã¦ã¿ã‚‹
    - ã§ããŸï¼
1. æ¯é€±å®Ÿæ–½ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ã‚ˆã£ã¦firebase-bomã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸ŠãŒã‚‹(33.3.0 â†’ 33.4.0)
1. ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‚’æ›´æ–°ã—ã¦ã€å†åº¦ç¢ºèª
    - ãªãœã‹å¤±æ•—ã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚ã€‚ã€‚

ãªã«ãŒã¤ã‚‰ã„ã£ã¦ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹æƒ…å ±ãŒçš†ç„¡ãªã‚“ã§ã™ã‚ˆã­ã€‚ã€‚

```
* Exception is:
org.gradle.api.tasks.TaskExecutionException: Execution failed for task ':app:testDemoDebugUnitTest'.
        at org.gradle.api.internal.tasks.execution.ExecuteActionsTaskExecuter.lambda$executeIfValid$1(ExecuteActionsTaskExecuter.java:130)
        at org.gradle.internal.Try$Failure.ifSuccessfulOrElse(Try.java:293)
        at org.gradle.api.internal.tasks.execution.ExecuteActionsTaskExecuter.executeIfValid(ExecuteActionsTaskExecuter.java:128)
        at org.gradle.api.internal.tasks.execution.ExecuteActionsTaskExecuter.execute(ExecuteActionsTaskExecuter.java:116)
        at org.gradle.api.internal.tasks.execution.FinalizePropertiesTaskExecuter.execute(FinalizePropertiesTaskExecuter.java:46)
        at org.gradle.api.internal.tasks.execution.ResolveTaskExecutionModeExecuter.execute(ResolveTaskExecutionModeExecuter.java:51)
        at org.gradle.api.internal.tasks.execution.SkipTaskWithNoActionsExecuter.execute(SkipTaskWithNoActionsExecuter.java:57)
        at org.gradle.api.internal.tasks.execution.SkipOnlyIfTaskExecuter.execute(SkipOnlyIfTaskExecuter.java:74)
        at org.gradle.api.internal.tasks.execution.CatchExceptionTaskExecuter.execute(CatchExceptionTaskExecuter.java:36)
        at org.gradle.api.internal.tasks.execution.EventFiringTaskExecuter$1.executeTask(EventFiringTaskExecuter.java:77)
        at org.gradle.api.internal.tasks.execution.EventFiringTaskExecuter$1.call(EventFiringTaskExecuter.java:55)
        at org.gradle.api.internal.tasks.execution.EventFiringTaskExecuter$1.call(EventFiringTaskExecuter.java:52)
        at org.gradle.internal.operations.DefaultBuildOperationRunner$CallableBuildOperationWorker.execute(DefaultBuildOperationRunner.java:209)
        at org.gradle.internal.operations.DefaultBuildOperationRunner$CallableBuildOperationWorker.execute(DefaultBuildOperationRunner.java:204)
        at org.gradle.internal.operations.DefaultBuildOperationRunner$2.execute(DefaultBuildOperationRunner.java:66)
        at org.gradle.internal.operations.DefaultBuildOperationRunner$2.execute(DefaultBuildOperationRunner.java:59)
        at org.gradle.internal.operations.DefaultBuildOperationRunner.execute(DefaultBuildOperationRunner.java:166)
        at org.gradle.internal.operations.DefaultBuildOperationRunner.execute(DefaultBuildOperationRunner.java:59)
        at org.gradle.internal.operations.DefaultBuildOperationRunner.call(DefaultBuildOperationRunner.java:53)
        at org.gradle.api.internal.tasks.execution.EventFiringTaskExecuter.execute(EventFiringTaskExecuter.java:52)
        at org.gradle.execution.plan.LocalTaskNodeExecutor.execute(LocalTaskNodeExecutor.java:42)
        at org.gradle.execution.taskgraph.DefaultTaskExecutionGraph$InvokeNodeExecutorsAction.execute(DefaultTaskExecutionGraph.java:331)
        at org.gradle.execution.taskgraph.DefaultTaskExecutionGraph$InvokeNodeExecutorsAction.execute(DefaultTaskExecutionGraph.java:318)
        at org.gradle.execution.taskgraph.DefaultTaskExecutionGraph$BuildOperationAwareExecutionAction.lambda$execute$0(DefaultTaskExecutionGraph.java:314)
        at org.gradle.internal.operations.CurrentBuildOperationRef.with(CurrentBuildOperationRef.java:85)
        at org.gradle.execution.taskgraph.DefaultTaskExecutionGraph$BuildOperationAwareExecutionAction.execute(DefaultTaskExecutionGraph.java:314)
        at org.gradle.execution.taskgraph.DefaultTaskExecutionGraph$BuildOperationAwareExecutionAction.execute(DefaultTaskExecutionGraph.java:303)
        at org.gradle.execution.plan.DefaultPlanExecutor$ExecutorWorker.execute(DefaultPlanExecutor.java:459)
        at org.gradle.execution.plan.DefaultPlanExecutor$ExecutorWorker.run(DefaultPlanExecutor.java:376)
        at org.gradle.internal.concurrent.ExecutorPolicy$CatchAndRecordFailures.onExecute(ExecutorPolicy.java:64)
        at org.gradle.internal.concurrent.AbstractManagedExecutor$1.run(AbstractManagedExecutor.java:48)
Caused by: org.gradle.process.internal.ExecException: Process 'Gradle Test Executor 19' finished with non-zero exit value 1
This problem might be caused by incorrect test process configuration.
For more on test execution, please refer to https://docs.gradle.org/8.10.2/userguide/java_testing.html#sec:test_execution in the Gradle documentation.
        at org.gradle.api.internal.tasks.testing.worker.ForkingTestClassProcessor.stop(ForkingTestClassProcessor.java:161)
        at org.gradle.api.internal.tasks.testing.processors.RestartEveryNTestClassProcessor.endBatch(RestartEveryNTestClassProcessor.java:77)
        at org.gradle.api.internal.tasks.testing.processors.RestartEveryNTestClassProcessor.stop(RestartEveryNTestClassProcessor.java:62)
        at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(Unknown Source)
        at org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:36)
        at org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:24)
        at org.gradle.internal.dispatch.FailureHandlingDispatch.dispatch(FailureHandlingDispatch.java:30)
        at org.gradle.internal.dispatch.AsyncDispatch.dispatchMessages(AsyncDispatch.java:87)
        at org.gradle.internal.dispatch.AsyncDispatch.access$000(AsyncDispatch.java:36)
        at org.gradle.internal.dispatch.AsyncDispatch$1.run(AsyncDispatch.java:71)
        at org.gradle.internal.concurrent.InterruptibleRunnable.run(InterruptibleRunnable.java:42)
        at org.gradle.internal.operations.CurrentBuildOperationRef.with(CurrentBuildOperationRef.java:85)
        at org.gradle.internal.operations.CurrentBuildOperationPreservingRunnable.run(CurrentBuildOperationPreservingRunnable.java:51)
        at org.gradle.internal.concurrent.ExecutorPolicy$CatchAndRecordFailures.onExecute(ExecutorPolicy.java:64)
        at org.gradle.internal.concurrent.AbstractManagedExecutor$1.run(AbstractManagedExecutor.java:48)
```

ãã—ã¦ã€ã“ã®çŠ¶æ…‹ã§å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã‚Œã‚‚ãªãœã‹å¤±æ•—ã™ã‚‹ã¨ã„ã†çŠ¶æ³ã€‚ã€‚

# æš«å®šå¯¾å¿œ

CIã§å®Ÿè¡Œã—ã¦ã„ã‚‹å˜ä½“ãƒ†ã‚¹ãƒˆã‚‚å¤±æ•—ã—ã¦ã„ã‚‹çŠ¶æ³ã¯çœ‹éã§ããªã„ã®ã§ã€ä¸€æ—¦roborazziç”¨ã®ãƒ“ãƒ«ãƒ‰è¨­å®šã¯`roborazzi.gradle`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ‡ã‚Šå‡ºã—ã¦ã€å®Ÿè¡Œã—ãŸã„ã¨ãã«é©ç”¨ã™ã‚‹ã¨ã„ã†é‹ç”¨ã«ã—ã¾ã—ãŸ

```groovy
// roborazzi.gradle
apply plugin: libs.plugins.roborazzi.get().pluginId

android {
    testOptions {
        unitTests {
            includeAndroidResources = true
            all {
                it.systemProperties["robolectric.pixelCopyRenderMode"] = "hardware"
            }
        }
    }
}

roborazzi.generateComposePreviewRobolectricTests.enable.set(true)
roborazzi.generateComposePreviewRobolectricTests.packages.set(["your.package.name"])
roborazzi.generateComposePreviewRobolectricTests.includePrivatePreviews.set(true)

dependencies {
    testImplementation(libs.junit)
    testImplementation(libs.robolectric)
    testImplementation(libs.roborazzi)
    testImplementation(libs.roborazzi.compose)
    testImplementation(libs.roborazzi.rule)
    testImplementation(libs.roborazziComposePreviewScannerSupport)
    testImplementation(libs.composablePreviewScannerAndroid)
}
```

```groovy
// build.gradle
// ...
// apply from: "path/to/roborazzi.gradle"
```

## roborazziã‚’ä½¿ã†æ‰‹é †

1. firebase-bomã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’33.3.0ã«ä¸‹ã’ã‚‹
1. roborazzi.gradleã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã™
1. `git switch develop` (ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒãŒdevelpãªã®ã§ãã†ã—ã¦ã„ã¾ã™)
1. `./gradlew recordRoborazzi`
1. `git switch feature/hoge`
1. `./gradlew compareRoborazzi`
1. `fd _compare --no-ignore --extension png -X mv {} .` (_compareã§çµ‚ã‚ã‚‹pngãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡º)
    - fdã£ã¦ã„ã†findã®ä»£æ›¿ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€findã‚’ä½¿ã†å ´åˆã¯èª­ã¿æ›¿ãˆã¦ãã ã•ã„

# ã©ã†ã‚„ã‚‰app-moduleã ã‘ãŒå¤±æ•—ã™ã‚‹ã‚‰ã—ã„

ãã®å¾Œã‚‚æ™‚é–“ãŒã‚ã‚‹ã¨ãã«åŸå› ã‚’èª¿æŸ»ã—ã¦ã„ã¾ã—ãŸã€‚

https://x.com/maruisannsimai/status/1855269025905012803

`recordRoborazzi`ã§ã¯ãªã`app:recordRoborazzi`ã‚„`hoge:recordRoborazzi`ã¨ã„ã£ãŸã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å˜ä½ã§ã®å®Ÿè¡Œã‚’è¦‹ãŸã¨ã“ã‚ã€app-moduleã ã‘ãŒå¤±æ•—ã™ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸã€‚

# Firebaseé–¢é€£ã®å®Ÿè£…ã‚’æ¶ˆã—ãŸã‚Šã€Fakeã«å·®ã—æ›¿ãˆã‚‹ã“ã¨ã§æˆåŠŸã™ã‚‹ã‚ˆã†ã«ãªã£ãŸğŸ‰

FirebaseãŒæ‚ªã•ã‚’ã—ã¦ã„ã‚‹ã“ã¨ã¯è–„ã€…æ°—ã¥ã„ã¦ã„ãŸã®ã§ã€Firebaseé–¢é€£ã®å®Ÿè£…ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ãŸã‚Šã€mockã«å·®ã—æ›¿ãˆãŸã‚Šã—ã¾ã—ãŸ

```kotlin
// ã“ã†ã„ã†ã®ã¨ã‹
// FirebaseApp.initializeApp(this)

// ã“ã†ã„ã†ã‚„ã¤
// FirebaseCrashlytics.getInstance() 
//      .setCrashlyticsCollectionEnabled(true) 
//
// RxJavaPlugins.setErrorHandler { 
//     FirebaseCrashlytics.getInstance() 
//         .recordException(it) 
// }
```

```kotlin
// DIã—ã¦ã„ã‚‹ç®‡æ‰€ã¯mockã«å¤‰ãˆã‚‹
@Provides
@Singleton
fun provideFirebaseRemoteConfig(
    // ...
): FirebaseRemoteConfig {
    return Mockito.mock()
}
```

ã“ã®ã‚ˆã†ã«ã—ãŸã¨ã“ã‚ã€`app:recordRoborazzi`ã‚‚å‹•ãã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã¨ã„ã†ã“ã¨ã§FirebaseãŒãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã‚’å¦¨ã’ã¦ã„ã¦ã€ãƒ¢ãƒƒã‚¯ãªã‚Šãƒ•ã‚§ã‚¤ã‚¯å®Ÿè£…ãªã‚Šã§å·®ã—æ›¿ãˆã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸã€‚

# roborazziãŒPreviewã‚’å…ƒã«ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ã„ã‚‹ã®ã§ã€å·®ã—æ›¿ãˆä¸å¯èƒ½ã€‚ã€‚

ã•ãã€DIè¨­å®šã‚’å·®ã—æ›¿ãˆã‚Œã°ã‚ˆã„ã“ã¨ã¯åˆ†ã‹ã‚Šã¾ã—ãŸãŒã€æ¬¡ã®å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
ãã‚Œã¯DIè¨­å®šã‚’å·®ã—æ›¿ãˆã‚‰ã‚Œãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚
è‡ªåˆ†ã®æ‰‹ã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã„ã‚‹å ´åˆã¯ã€`@TestInstallIn`ã¨ã‹`@HiltAndroidTest`ã‚’ä½¿ã£ã¦å·®ã—æ›¿ãˆã‚Œã°ã‚ˆã„ã ã‘ã§ã™ãŒã€ä»Šå›åƒ•ã¯roborazziã®ä¾¿åˆ©ãªæ©Ÿèƒ½ã§ã‚ã‚‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ™ãƒ¼ã‚¹ã«ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
[https://github.com/takahirom/roborazzi?tab=readme-ov-file#generate-compose-preview-screenshot-tests](https://github.com/takahirom/roborazzi?tab=readme-ov-file#generate-compose-preview-screenshot-tests)
è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã«å¯¾ã—ã¦ã“ã¡ã‚‰ãŒã§ãã‚‹ã“ã¨ã¯ãªã„ã®ã§å·®ã—æ›¿ãˆã‚‹ã“ã¨ã¯ä¸å¯èƒ½ã ã¨ã„ã†ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸã€‚
ã¨ã„ã†ã“ã¨ã§app-moduleã«ã¤ã„ã¦ã¯è‡ªå‹•ç”Ÿæˆã‚’ã¤ã‹ã£ãŸãƒ†ã‚¹ãƒˆã¯è«¦ã‚ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

# ã¤ãã¯ã©ã†ã™ã‚‹ã®ã‹

- app-moduleä»¥å¤–: roborazzi(è‡ªå‹•)ã‚’é©ç”¨ã™ã‚‹
- app-module: å¿…è¦ãŒã‚ã‚Œã°æ‰‹å‹•ã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
- ç¾çŠ¶ç”»é¢ãƒ¬ãƒ™ãƒ«ã®Composableé–¢æ•°ãŒapp-moduleã«ã„ã‚‹ã®ã§ã€é©å½“ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ç§»å‹•ã•ã›ã‚‹
