---
title: "Gsonã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ®ºã•ã‚ŒãŸæ—¥"
emoji: "ğŸ’€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["android","kotlin"]
published: false
publication_name: "karabiner_inc"
---

APIé€šä¿¡å‘¨ã‚Šã®å®Ÿè£…ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ãŸã‚‰ãƒã‚°ã‚’åŸ‹ã‚è¾¼ã‚“ã§ã—ã¾ã£ãŸã®ã§ãã“ã‹ã‚‰å¾—ã‚‰ã‚ŒãŸçŸ¥è¦‹ã‚’å…±æœ‰ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## ã“ã®è¨˜äº‹ã§å¾—ã‚‰ã‚Œã‚‹æ•™è¨“

- ä½¿ã£ã¦ã„ã‚‹Javaè£½ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¤ã„ã¦Kotlinè£½ã®ä»£æ›¿ãŒã‚ã‚‹ãªã‚‰ãã¡ã‚‰ã«ç§»è¡Œã—ãŸã»ã†ãŒã‚ˆã„
- Kotlinã¯Javaã«ã¯ãªã„æ©Ÿèƒ½ãŒã‚ã‚‹ãŸã‚ã€Kotlinã®å®Ÿè£…ã¯æ‚ªããªã•ãã†ã«è¦‹ãˆã¦ã‚‚äºˆæœŸã—ãªã„æŒ¯ã‚‹èˆã„ã‚’ã¨ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹
- ã¨ãã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã‹non-nullå‘¨ã‚Š

## ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ ¼ç´ã™ã‚‹data classã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ãŸ

ã¨ã‚ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ ¼ç´ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã—ãŸã€‚
ãã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯å‡¦ç†ã®æˆåŠŸ/å¤±æ•—ã‚’è¡¨ã™`status`ã¨ã„ã†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¡ã€ãã®å€¤ãŒ`success`ã‹å¦ã‹ã§æˆåŠŸ/å¤±æ•—ã‚’åˆ¤å®šã—ã¦ã„ã¾ã™ã€‚

```json
{ "status": "success" }
```

ã‚¯ãƒ©ã‚¹ã¯æ¬¡ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¦ã€æˆåŠŸã‹ã©ã†ã‹ã‚’åˆ¤åˆ¥ã™ã‚‹ãŸã‚ã®`isSuccess`ã¨ã„ã†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”¨æ„ã—ã¦ã„ã¾ã—ãŸã€‚

```kotlin
// before
data class ResultResponse(
    private val status: String? = null,
) {
    val isSuccess: Boolean
        get() = "success" == this.status
}
```

åˆ¥ã«`status`ã®å€¤ã¯å‚ç…§ã™ã‚‹ãŸã³ã«å¤‰åŒ–ã™ã‚‹ã‚‚ã®ã§ã‚‚ãªã„ãŸã‚ã€ã‚«ã‚¹ã‚¿ãƒ ã‚²ãƒƒã‚¿ãƒ¼ã§ã‚ã‚‹å¿…è¦ã¯ãªã„ãªã¨ãŠã‚‚ã£ãŸã®ã§ã€æ™®é€šã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

```kotlin
// after
data class ResultResponse(
    private val status: String? = null,
) {
    val isSuccess = "success" == this.status
}
```

Repositoryã§ã¯`isSuccess`ãŒfalseã ã£ãŸã‚‰ä¾‹å¤–ã‚’åã„ã¦ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ‰±ã„ã•ã‚Œã‚‹ã‚ˆã†ã«ä½œã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

```kotlin
    .map {
        if (!it.isSuccess) {
            throw RuntimeException()
        }
    }
```

## Crashlyticsã®éè‡´å‘½çš„ä¾‹å¤–ã®ä»¶æ•°ãŒå¢—ãˆã¦ã„ã‚‹

ã“ã®å¤‰æ›´ã‚’å«ã‚“ã ã‚‚ã®ã‚’ã„ã–ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã—ãŸã€‚
æœ€åˆã¯30%ã§å…¬é–‹ã—ã¦ã€1æ—¥æ§˜å­ã‚’Crashlyticsã§è¦‹ã¦ã€ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãŒç™ºç”Ÿã—ã¦ã„ãªã‹ã£ãŸã®ã§ã€99.99999%ã«æ›´æ–°ã—ã¾ã—ãŸã€‚
æ›´æ–°å¾Œã‚‚ç‰¹ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã¯å‡ºã¦ã„ãªã‹ã£ãŸã®ã§ã€ã¤ã„ã§ã«éè‡´å‘½çš„ä¾‹å¤–ã‚’è¦‹ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
ãã“ã§ä»Šå›å¤‰æ›´ã‚’åŠ ãˆãŸç®‡æ‰€ã‹ã‚‰ä¾‹å¤–ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã®ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚

![](/images/8f55019481549b/crashlytics.png)

ä¾‹å¤–ãŒåã‹ã‚ŒãŸå ´åˆã®æŒ™å‹•ãŒã©ã†ãªã‚‹ã®ã‹ã‚’ç¢ºèªã™ã‚‹ã¨ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã“ã¨ã‚’ç¤ºã™ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã€å†èµ·å‹•ã—ãªã„é™ã‚Šã€ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãæ›´æ–°ã•ã‚Œãªã„çŠ¶æ…‹ã§ã—ãŸã€‚
ã“ã‚Œã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«æ‚ªå½±éŸ¿ã‚’ä¸ãˆã¦ã—ã¾ã†ã®ã§ã€ãƒªãƒªãƒ¼ã‚¹ã‚’åœæ­¢ã—ã¦ãƒã‚°ã®åŸå› ã‚’èª¿æŸ»ã—å§‹ã‚ã¾ã—ãŸã€‚

## alwayså¤±æ•—æ‰±ã„ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹

å…ˆã®ä¾‹å¤–ãŒåã‹ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå¤±æ•—æ‰±ã„ã«ãªã£ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚å†èµ·å‹•ã—ãŸã‚‰æ­£ã—ãæç”»ã§ãã‚‹ã¨ã„ã†ã“ã¨ã¯å‡¦ç†è‡ªä½“ã¯æˆåŠŸã—ã¦ã„ãŸã¨ã„ã†ã“ã¨ã§ã™ã€‚ã¨ã„ã†ã“ã¨ã¯æˆåŠŸã—ã¦ã„ã‚‹ã«ã‚‚é–¢ã‚‰ãšã€å¤±æ•—æ‰±ã„ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚
ãã“ã§æ€ªã—ã‚“ã ã®ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®JSONã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã®ã«ä½¿ã£ã¦ã„ã‚‹[Gson](https://github.com/google/gson)ã§ã™ã€‚
æ‰‹å…ƒã§ç›´æ¥JSONã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã¿ãŸã¨ã“ã‚ã€statusã¯successã«ãªã£ã¦ã„ã‚‹ã®ã«ã€isSuccessã¯falseã«ãªã£ã¦ã„ã‚‹ã¨ã„ã†è¬ã®çŠ¶æ…‹ã§ã—ãŸã€‚

```kotlin
fun main() {
    val result = Gson().fromString(
        """{"status": "success"}""",
        ResultResponse::class.java,
    )
    println("result: ${result}")
    println("isSuccess: ${result.isSuccess}")
}

// result: ResultResponse(success)
// isSuccess: false â† ãƒ•ã‚¡ãƒƒ!?
```

## GsonãŒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆæ™‚ã«nullã‚’ã‚»ãƒƒãƒˆã—ã¦ã„ã‚‹

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œã‚‰ã‚ŒãŸinitã®æ™‚ç‚¹ã§statusãŒã©ã†ãªã£ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ãŸã¨ã“ã‚ã€ã“ã®æ™‚ã«nullã«ãªã£ã¦ã¾ã—ãŸã€‚

```kotlin
data class ResultResponse(
    private val status: String? = null,
) {
    init {
        println("status: $status")
    }
    val isSuccess = "success" == this.status
}

fun main() {
    val result = Gson().fromString(
        """{"status": "success"}""",
        ResultResponse::class.java,
    )
    println("isSuccess: ${result.isSuccess}")
}

// status: null â† ãƒ•ã‚¡ãƒƒ!?!?
// isSuccess: false
```

GsonãŒJavaè£½ã§ã‚ã‚‹ã“ã¨ã¨ã€ãƒ‘ãƒ¼ã‚¹ã«ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‚’é‘‘ã¿ã‚‹ã¨ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆæ™‚ã«ã¯å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒnullã§ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¦ã€ãã®å¾Œãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®é»’é­”è¡“ã«ã‚ˆã£ã¦æœ¬æ¥ã®å€¤ã§æ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã‚“ã ã‚ã†ã¨æ¨æ¸¬ã—ã¾ã—ãŸã€‚
isSuccessã¯ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆæ™‚ã®å€¤ã‚’ä½¿ã£ã¦è¨ˆç®—ã—ã¦ã„ã‚‹ãŸã‚ `"success" == null` => `false` ã¨ã„ã†ã“ã¨ã«ãªã£ãŸã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹
Kotlinã®å®Ÿè£…ã‚’è¦‹ã‚‹é™ã‚Šã§ã¯å…¨ãå•é¡Œãªã•ãã†ã«ã¿ãˆã‚‹ã®ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã™ã‚ŠæŠœã‘ã¦ã—ã¾ã„ã¾ã—ãŸã€‚ã€‚
ã—ã‚‡ã†ãŒãªã„ã®ã§ã‚«ã‚¹ã‚¿ãƒ ã‚²ãƒƒã‚¿ãƒ¼ã®å®Ÿè£…ã«æˆ»ã—ã¾ã—ãŸã€‚

Gsonã®READMEã‚’è¦‹ã‚‹ã¨Kotlinã¨ã‹ã§ä½¿ã†ã¨ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„æ©Ÿèƒ½ã«ã‚ˆã£ã¦æ„å›³ã—ãªã„æŒ™å‹•ã¨ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã‹ã‚‰æ³¨æ„ã—ã¦ã­ã¨æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã­ã€‚ã€‚

> [!IMPORTANT]\
> Gson's main focus is on Java. Using it with other JVM languages such as Kotlin or Scala might work fine in many cases, but language-specific features such as Kotlin's non-`null` types or constructors with default arguments are not supported. This can lead to confusing and incorrect behavior.\
> When using languages other than Java, prefer a JSON library with explicit support for that language.

## kotlinx-serializationã‚’ä½¿ã£ã¦ã¿ã‚‹

ç´”Kotlinè£½ã®ãƒ‘ãƒ¼ã‚µãƒ¼ã§ã‚ã‚‹kotlinx-serializationã§æŒ™å‹•ã‚’è¦‹ã¦ã¿ãŸã¨ã“ã‚ã€ã“ã¡ã‚‰ã¯æœŸå¾…ã©ãŠã‚Šã®å‹•ãã‚’ã—ã¦ã„ã¾ã—ãŸã€‚

```kotlin
fun main() {
    val result = Json.decodeFromString<ResultResponse>(
        """{"status": "success"}""",
    )
    println("isSuccess: ${result.isSuccess}")
}

// status: success
// isSuccess: true
```

ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ãŒKotlinã§ã‚ã‚‹ä»¥ä¸Šã€å®Œå…¨ã«æœŸå¾…ã©ãŠã‚Šã®æŒ¯ã‚‹èˆã„ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã«ã¯ã§ãã‚‹ã ã‘Javaã®è³‡ç”£ã¯é¿ã‘ãŸã»ã†ãŒã‚ˆã„ãªã¨æ€ã„ã¾ã—ãŸã€‚
