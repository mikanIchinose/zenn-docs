---
title: "å…¥é–€ Jetpack Compose Animation part3"
emoji: "ğŸ’«"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["android","jetpackcompose"]
published: true
---

## ã¯ã˜ã‚ã«

å‰å›ã¯ã€[Value-based animations](https://developer.android.com/develop/ui/compose/animation/value-based)ã‚’èª­ã‚“ã§å­¦ç¿’ã—ãŸå†…å®¹ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚
ä»Šå›ã¯ã€[Advanced animation example](https://developer.android.com/develop/ui/compose/animation/advanced)ã‚’èª­ã‚“ã§å­¦ç¿’ã—ãŸå†…å®¹ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

## ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ„ã¿åˆã‚ã›ã‚‹å ´åˆã¯æ³¨æ„ã™ã‚‹ã“ã¨ãŒå¢—ãˆã¾ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚ˆã‚Šã‚‚å„ªå…ˆã•ã‚Œã€ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆãŒé–‹å§‹ã•ã‚ŒãŸã‚‰ã€ãŸã¨ãˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é€”ä¸­ã§ã‚ã£ã¦ã‚‚ä¸­æ–­ã—ã¦æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã«åå¿œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼

![](/images/85dc6c77d1e2bc/GestureSample.gif)
*ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚µãƒ³ãƒ—ãƒ«: ã‚¿ãƒƒãƒ—ã§é’ã„å††ãŒç§»å‹•ã™ã‚‹æ§˜å­*

```kotlin
@Composable
fun Gesture(modifier: Modifier = Modifier) {
    // you can use Animatable to change Offset
    val offset = remember { Animatable(Offset.Zero, Offset.VectorConverter) }
    val scope = rememberCoroutineScope()
    Box(
        modifier = modifier
            .fillMaxSize()
            .pointerInput(Unit) {
                // using high level api
                detectTapGestures {
                    scope.launch {
                        // cancel after new tap event comming
                        offset.animateTo(it)
                    }
                }

                // using low level api
                coroutineScope {
                    // cancel after new tap event comming
                    while (true) {
                        awaitPointerEventScope {
                            val position = awaitFirstDown().position
                            launch {
                                offset.animateTo(position)
                            }
                        }
                    }
                }
            }
    ) {
        Box(
            modifier = Modifier
                .offset { offset.value.toIntOffset() }
                .size(100.dp)
                .background(Color.Blue, shape = CircleShape)
        )
    }
}

private fun Offset.toIntOffset() = IntOffset(x.roundToInt(), y.roundToInt())
```

### è‡ªä½œSwipeToDismiss

![](/images/85dc6c77d1e2bc/SwipeToDismissSample.gif)
*ã‚¹ãƒ¯ã‚¤ãƒ—ã§è¦ç´ ã‚’ç”»é¢å¤–ã«Dismissã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«*

```kotlin
fun Modifier.swipeToDismiss(
    onDismissed: () -> Unit
): Modifier = composed {
    val offsetX = remember { Animatable(0f) }
    pointerInput(Unit) {
        val decay = splineBasedDecay<Float>(this)
        coroutineScope {
            while (true) {
                val velocityTracker = VelocityTracker()
                // 1
                offsetX.stop()
                awaitPointerEventScope {
                    val pointerId = awaitFirstDown().id
                    horizontalDrag(pointerId) { change ->
                        launch {
                            // 2
                            offsetX.snapTo(offsetX.value + change.positionChange().x)
                        }
                        velocityTracker.addPosition(
                            change.uptimeMillis,
                            change.position,
                        )
                    }
                }
                // ã‚¹ãƒ¯ã‚¤ãƒ—ã®é€Ÿåº¦ã‚’è¨ˆæ¸¬
                val velocity = velocityTracker.calculateVelocity().x
                val targetOffsetX = decay.calculateTargetValue(offsetX.value, velocity)
                offsetX.updateBounds(
                    lowerBound = -size.width.toFloat(),
                    upperBound = size.width.toFloat(),
                )
                launch {
                    if (targetOffsetX.absoluteValue <= size.width) {
                        // 3
                        offsetX.animateTo(
                            targetValue = 0f,
                            initialVelocity = velocity,
                        )
                    } else {
                        // 4
                        offsetX.animateDecay(velocity, decay)
                        onDismissed()
                    }
                }
            }
        }
    }
        .offset { IntOffset(offsetX.value.roundToInt(), 0) }
}
```

```kotlin
@Composable
fun TodoList(modifier: Modifier = Modifier) {
    val todos = remember {
        mutableStateListOf(
            "Take out the trash",
            "Do the dishes",
            "Write a blog post",
        )
    }

    LazyColumn(
        modifier = modifier.padding(16.dp),
        verticalArrangement = Arrangement.spacedBy(32.dp)
    ) {
        items(todos, { it }) { text ->
            Box(
                modifier = Modifier
                    .swipeToDismiss(
                        onDismissed = {
                            todos.remove(text)
                        }
                    )
                    .padding(horizontal = 16.dp)
                    .background(
                        color = MaterialTheme.colorScheme.secondaryContainer,
                        shape = RoundedCornerShape(8.dp),
                    )
                    .padding(16.dp)
                    .height(100.dp)
                    .fillMaxWidth()
            ) {
                Text(
                    text = text,
                    color = MaterialTheme.colorScheme.onSecondaryContainer,
                )
            }
        }
    }
}
```

:::message alert
1. ã‚¿ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œçŸ¥ã—ãŸã‚‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã—ã¾ã™ã€‚
2. æ°´å¹³æ–¹å‘ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œçŸ¥ã—ã€`offsetX`ã®å€¤ã‚’å³åº§ã«æ›´æ–°ã—ã¾ã™ã€‚ (`snapTo`ã‚’ä½¿ç”¨)
3. ã‚ªãƒ•ã‚»ãƒƒãƒˆãŒå¹…ã‚’è¶…ãˆãªã„å ´åˆã¯ã€`animateTo`ã§å…ƒã®ä½ç½®ã¸æˆ»ã‚Šã¾ã™ã€‚
4. ã‚ªãƒ•ã‚»ãƒƒãƒˆãŒå¹…ã‚’è¶…ãˆãŸå ´åˆã¯ã€`animateDecay`ã§æ¸›è¡°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«`onDismissed`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
:::

:::details ä½™è«‡
`offsetX.updateBounds`ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç¯„å›²ã‚’åˆ¶é™ã—ã€ç”»é¢å¤–ã¸ã®éåº¦ãªç§»å‹•ã‚’é˜²ãã¾ã™ã€‚
`animateDecay`ã¯æ…£æ€§ã‚„ç‰©ç†çš„æŒ™å‹•ã‚’æ¨¡å€£ã—ãŸæ¸›è¡°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æä¾›ã—ã¾ã™ã€‚
:::